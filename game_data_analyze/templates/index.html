<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaZero Clique Game Visualizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .container {
            flex: 1;
            display: flex;
            gap: 1rem;
            padding: 1rem;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }
        
        .sidebar {
            width: 300px;
            background: white;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            max-height: calc(100vh - 100px);
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .canvas-container {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            height: 500px;
        }
        
        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .controls {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .info-panel {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .file-list {
            list-style: none;
            margin-top: 1rem;
        }
        
        .file-item {
            padding: 0.5rem;
            margin: 0.2rem 0;
            background: #f5f5f5;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }
        
        .file-item:hover {
            background: #e0e0e0;
            transform: translateX(5px);
        }
        
        .file-item.selected {
            background: #667eea;
            color: white;
        }
        
        .file-item .type {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75rem;
            margin-left: 5px;
        }
        
        .file-item .type.training {
            background: #4caf50;
            color: white;
        }
        
        .file-item .type.evaluation {
            background: #ff9800;
            color: white;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0.2rem;
        }
        
        button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .control-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 0.5rem 0;
        }
        
        input[type="range"] {
            flex: 1;
        }
        
        select {
            padding: 0.5rem;
            border-radius: 5px;
            border: 1px solid #ddd;
            background: white;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .stat-item {
            background: #f5f5f5;
            padding: 0.8rem;
            border-radius: 5px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.2rem;
        }
        
        .move-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .move-detail {
            background: #f5f5f5;
            padding: 0.8rem;
            border-radius: 5px;
        }
        
        .move-detail h4 {
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        
        .probability-bar {
            background: #e0e0e0;
            height: 20px;
            border-radius: 3px;
            margin: 0.2rem 0;
            position: relative;
            overflow: hidden;
        }
        
        .probability-fill {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            transition: width 0.3s;
        }
        
        .probability-text {
            position: absolute;
            top: 50%;
            left: 5px;
            transform: translateY(-50%);
            font-size: 0.75rem;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
        }
        
        .legend {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            font-size: 0.85rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <header>
        <h1>üéÆ AlphaZero Clique Game Visualizer</h1>
    </header>
    
    <div class="container">
        <div class="sidebar">
            <h3>üìÅ Available Files</h3>
            <div id="fileListContainer" class="loading">Loading files...</div>
        </div>
        
        <div class="main-content">
            <div class="canvas-container">
                <canvas id="gameCanvas"></canvas>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff4444;"></div>
                        <span>Player 0</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4444ff;"></div>
                        <span>Player 1</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffff44;"></div>
                        <span>Current Move</span>
                    </div>
                </div>
            </div>
            
            <div class="controls">
                <div class="control-row">
                    <label>Game:</label>
                    <select id="gameSelect" disabled>
                        <option>No games loaded</option>
                    </select>
                    <label>Move:</label>
                    <input type="range" id="moveSlider" min="0" max="0" value="0" disabled>
                    <span id="moveLabel">0/0</span>
                </div>
                
                <div class="control-row">
                    <button id="prevBtn" disabled>‚èÆ Previous</button>
                    <button id="playBtn" disabled>‚ñ∂ Play</button>
                    <button id="nextBtn" disabled>‚è≠ Next</button>
                    <button id="resetBtn" disabled>üîÑ Reset</button>
                </div>
                
                <div class="control-row">
                    <label>Speed:</label>
                    <input type="range" id="speedSlider" min="0.5" max="3" step="0.5" value="1">
                    <span id="speedLabel">1x</span>
                </div>
            </div>
            
            <div class="info-panel">
                <h3>üìä Game Information</h3>
                <div id="loadingIndicator" style="display: none; color: #666; font-style: italic;">Loading...</div>
                <div id="gameStatus">No game loaded</div>
                <div id="gameStats" class="stats"></div>
                <div id="moveInfo" class="move-info"></div>
            </div>
        </div>
    </div>
    
    <script>
        // Global state
        let currentData = null;
        let gameCache = {}; // Cache for loaded individual game data
        let currentGame = null;
        let currentGameIdx = 0;
        let currentMoveIdx = 0;
        let isPlaying = false;
        let playInterval = null;
        let playSpeed = 1;
        
        // Canvas setup
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Initialize
        window.addEventListener('load', () => {
            loadFileList();
            setupEventListeners();
            resizeCanvas();
        });
        
        window.addEventListener('resize', resizeCanvas);
        
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth - 32;
            canvas.height = container.clientHeight - 52;
            if (currentData) {
                drawGame();
            }
        }
        
        async function loadFileList() {
            try {
                const response = await fetch('/api/list_files');
                const files = await response.json();
                displayFileList(files);
            } catch (error) {
                document.getElementById('fileListContainer').innerHTML = 
                    '<div class="error">Failed to load files: ' + error.message + '</div>';
            }
        }
        
        function displayFileList(files) {
            if (files.length === 0) {
                document.getElementById('fileListContainer').innerHTML = 
                    '<div class="error">No game data files found</div>';
                return;
            }
            
            const listHtml = files.map(file => `
                <li class="file-item" data-path="${file.path}">
                    <div>${file.iteration}</div>
                    <small>${file.experiment}</small>
                    <span class="type ${file.type}">${file.type}</span>
                </li>
            `).join('');
            
            document.getElementById('fileListContainer').innerHTML = 
                '<ul class="file-list">' + listHtml + '</ul>';
            
            // Add click handlers
            document.querySelectorAll('.file-item').forEach(item => {
                item.addEventListener('click', () => loadGameFile(item.dataset.path));
            });
        }
        
        async function loadGameFile(filepath) {
            // Update selected state
            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector(`[data-path="${filepath}"]`).classList.add('selected');
            
            // Show loading indicator
            document.getElementById('loadingIndicator').style.display = 'block';
            
            try {
                // Load only metadata first (fast)
                const response = await fetch('/api/load_file?file=' + encodeURIComponent(filepath));
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Store metadata and layout
                currentData = {
                    ...data.metadata,
                    ...data.layout,
                    currentFile: filepath
                };
                currentGameIdx = 0;
                currentMoveIdx = 0;
                
                setupGameControls();
                // Load first game data
                await loadGame(0);
                updateStats();
            } catch (error) {
                alert('Failed to load game file: ' + error.message);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }
        
        function setupGameControls() {
            const gameSelect = document.getElementById('gameSelect');
            gameSelect.innerHTML = currentData.game_summaries.map((game, idx) => 
                `<option value="${idx}">Game ${game.game_id + 1} (${game.num_moves} moves)</option>`
            ).join('');
            gameSelect.disabled = false;
            
            // Enable controls
            document.getElementById('moveSlider').disabled = false;
            document.getElementById('prevBtn').disabled = false;
            document.getElementById('playBtn').disabled = false;
            document.getElementById('nextBtn').disabled = false;
            document.getElementById('resetBtn').disabled = false;
        }
        
        async function loadGame(gameIdx) {
            currentGameIdx = gameIdx;
            
            // Check if game is already loaded in cache
            const cacheKey = `${currentData.currentFile}:game_${gameIdx}`;
            if (!gameCache[cacheKey]) {
                // Show mini loading indicator for game load
                document.getElementById('gameStatus').textContent = 'Loading game data...';
                
                try {
                    const response = await fetch(`/api/load_game?file=${encodeURIComponent(currentData.currentFile)}&game_idx=${gameIdx}`);
                    const gameData = await response.json();
                    
                    if (gameData.error) {
                        throw new Error(gameData.error);
                    }
                    
                    gameCache[cacheKey] = gameData;
                } catch (error) {
                    alert('Failed to load game data: ' + error.message);
                    return;
                }
            }
            
            currentGame = gameCache[cacheKey];
            currentMoveIdx = 0;
            
            // Update move slider
            const moveSlider = document.getElementById('moveSlider');
            moveSlider.max = currentGame.moves.length - 1;
            moveSlider.value = 0;
            
            document.getElementById('gameStatus').textContent = `Game ${currentGame.game_id + 1}`;
            updateMoveDisplay();
            drawGame();
        }
        
        function updateMoveDisplay() {
            document.getElementById('moveLabel').textContent = 
                `${currentMoveIdx + 1}/${currentGame.moves.length}`;
            document.getElementById('moveSlider').value = currentMoveIdx;
            
            drawGame();
            updateMoveInfo();
        }
        
        function drawGame() {
            if (!currentData || !currentGame) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const n = currentData.n;
            const positions = currentData.node_positions;
            const edges = currentData.edges;
            
            // Build current edge states
            const edgeStates = {};
            for (let i = 0; i <= currentMoveIdx; i++) {
                const move = currentGame.moves[i];
                if (move.action !== undefined) {
                    edgeStates[move.action] = move.player + 1;
                }
            }
            
            // Scale positions to canvas
            const padding = 50;
            const scaleX = (canvas.width - 2 * padding);
            const scaleY = (canvas.height - 2 * padding);
            
            const scaledPos = {};
            for (let i = 0; i < n; i++) {
                const pos = positions[i.toString()];
                scaledPos[i] = [
                    padding + (pos[0] + 1) * scaleX / 2,
                    padding + (pos[1] + 1) * scaleY / 2
                ];
            }
            
            // Draw edges
            edges.forEach(edge => {
                const from = scaledPos[edge.source];
                const to = scaledPos[edge.target];
                
                ctx.beginPath();
                ctx.moveTo(from[0], from[1]);
                ctx.lineTo(to[0], to[1]);
                
                const state = edgeStates[edge.id];
                if (state === 1) {
                    ctx.strokeStyle = '#ff4444';
                    ctx.lineWidth = 3;
                } else if (state === 2) {
                    ctx.strokeStyle = '#4444ff';
                    ctx.lineWidth = 3;
                } else {
                    ctx.strokeStyle = '#ddd';
                    ctx.lineWidth = 1;
                }
                
                // Highlight current move
                const currentMove = currentGame.moves[currentMoveIdx];
                if (currentMove && currentMove.action === edge.id) {
                    ctx.strokeStyle = '#ffff44';
                    ctx.lineWidth = 5;
                }
                
                ctx.stroke();
            });
            
            // Draw nodes
            for (let i = 0; i < n; i++) {
                const pos = scaledPos[i];
                
                ctx.beginPath();
                ctx.arc(pos[0], pos[1], 15, 0, 2 * Math.PI);
                ctx.fillStyle = 'white';
                ctx.fill();
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(i.toString(), pos[0], pos[1]);
            }
        }
        
        function updateMoveInfo() {
            const move = currentGame.moves[currentMoveIdx];
            const moveInfoDiv = document.getElementById('moveInfo');
            
            let html = '<div class="move-detail">';
            html += '<h4>Current Move</h4>';
            html += `<p>Player: ${move.player}</p>`;
            
            if (move.edge) {
                html += `<p>Edge: (${move.edge[0]}, ${move.edge[1]})</p>`;
            }
            
            if (move.value !== undefined) {
                html += `<p>Value: ${move.value.toFixed(3)}</p>`;
            }
            
            if (currentData.is_eval && move.model_used) {
                html += `<p>Model: ${move.model_used}</p>`;
            }
            
            html += '</div>';
            
            // Show visit counts if available
            if (move.top_visits && move.top_visits.length > 0) {
                html += '<div class="move-detail">';
                html += '<h4>MCTS Visit Counts</h4>';
                
                const totalVisits = move.top_visits.reduce((sum, v) => sum + v.visits, 0);
                move.top_visits.slice(0, 5).forEach(action => {
                    const visits = action.visits;
                    const edge = action.edge;
                    const isSelected = action.action === move.action;
                    const percentage = (visits / totalVisits * 100).toFixed(1);
                    
                    html += '<div class="probability-bar">';
                    html += `<div class="probability-fill" style="width: ${percentage}%; ${isSelected ? 'background: #44ff44;' : 'background: #4488ff;'}"></div>`;
                    html += `<div class="probability-text">(${edge[0]},${edge[1]}): ${visits} visits (${percentage}%)</div>`;
                    html += '</div>';
                });
                
                html += '</div>';
            }
            
            // Show top actions (final probabilities after temperature)
            if (move.top_actions && move.top_actions.length > 0) {
                html += '<div class="move-detail">';
                html += '<h4>Final Action Probabilities</h4>';
                
                move.top_actions.slice(0, 5).forEach(action => {
                    const prob = action.prob;
                    const edge = action.edge;
                    const isSelected = action.action === move.action;
                    
                    html += '<div class="probability-bar">';
                    html += `<div class="probability-fill" style="width: ${prob * 100}%; ${isSelected ? 'background: #ffff44;' : ''}"></div>`;
                    html += `<div class="probability-text">(${edge[0]},${edge[1]}): ${(prob * 100).toFixed(1)}%</div>`;
                    html += '</div>';
                });
                
                html += '</div>';
            }
            
            // Show game result if on last move
            if (currentMoveIdx === currentGame.moves.length - 1) {
                html += '<div class="move-detail">';
                html += '<h4>Game Result</h4>';
                
                if (currentGame.num_moves === currentData.n * (currentData.n - 1) / 2) {
                    html += '<p>üéØ Draw - All edges colored!</p>';
                    if (currentData.game_mode === 'avoid_clique') {
                        html += '<p>‚ú® Potential Ramsey counterexample!</p>';
                    }
                } else {
                    const winner = currentGame.winner;
                    if (winner !== undefined && winner !== null) {
                        html += `<p>üèÜ Player ${winner} wins!</p>`;
                    }
                }
                
                html += '</div>';
            }
            
            moveInfoDiv.innerHTML = html;
        }
        
        async function updateStats() {
            try {
                const response = await fetch(`/api/stats?file=${encodeURIComponent(currentData.currentFile)}`);
                const stats = await response.json();
                
                const statsDiv = document.getElementById('gameStats');
                let html = '';
                
                html += `<div class="stat-item">
                    <div class="stat-value">${stats.total_games}</div>
                    <div class="stat-label">Total Games</div>
                </div>`;
                
                html += `<div class="stat-item">
                    <div class="stat-value">${stats.avg_length.toFixed(1)}</div>
                    <div class="stat-label">Avg Length</div>
                </div>`;
                
                html += `<div class="stat-item">
                    <div class="stat-value">${stats.complete_games}</div>
                    <div class="stat-label">Complete Games</div>
                </div>`;
                
                if (currentData.is_eval) {
                    html += `<div class="stat-item">
                        <div class="stat-value">${stats.current_wins}</div>
                        <div class="stat-label">Current Wins</div>
                    </div>`;
                    
                    html += `<div class="stat-item">
                        <div class="stat-value">${stats.baseline_wins}</div>
                        <div class="stat-label">Baseline Wins</div>
                    </div>`;
                } else {
                    html += `<div class="stat-item">
                        <div class="stat-value">${stats.p0_wins}</div>
                        <div class="stat-label">P0 Wins</div>
                    </div>`;
                    
                    html += `<div class="stat-item">
                        <div class="stat-value">${stats.p1_wins}</div>
                        <div class="stat-label">P1 Wins</div>
                    </div>`;
                }
                
                html += `<div class="stat-item">
                    <div class="stat-value">${stats.draws}</div>
                    <div class="stat-label">Draws</div>
                </div>`;
                
                statsDiv.innerHTML = html;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }
        
        function setupEventListeners() {
            // Game selection
            document.getElementById('gameSelect').addEventListener('change', async (e) => {
                await loadGame(parseInt(e.target.value));
            });
            
            // Move slider
            document.getElementById('moveSlider').addEventListener('input', (e) => {
                currentMoveIdx = parseInt(e.target.value);
                updateMoveDisplay();
            });
            
            // Control buttons
            document.getElementById('prevBtn').addEventListener('click', () => {
                if (currentMoveIdx > 0) {
                    currentMoveIdx--;
                    updateMoveDisplay();
                }
            });
            
            document.getElementById('nextBtn').addEventListener('click', () => {
                if (currentMoveIdx < currentGame.moves.length - 1) {
                    currentMoveIdx++;
                    updateMoveDisplay();
                }
            });
            
            document.getElementById('resetBtn').addEventListener('click', () => {
                currentMoveIdx = 0;
                updateMoveDisplay();
            });
            
            document.getElementById('playBtn').addEventListener('click', togglePlay);
            
            // Speed control
            document.getElementById('speedSlider').addEventListener('input', (e) => {
                playSpeed = parseFloat(e.target.value);
                document.getElementById('speedLabel').textContent = playSpeed + 'x';
                
                if (isPlaying) {
                    stopPlay();
                    startPlay();
                }
            });
        }
        
        function togglePlay() {
            if (isPlaying) {
                stopPlay();
            } else {
                startPlay();
            }
        }
        
        function startPlay() {
            isPlaying = true;
            document.getElementById('playBtn').textContent = '‚è∏ Pause';
            
            playInterval = setInterval(() => {
                if (currentMoveIdx < currentGame.moves.length - 1) {
                    currentMoveIdx++;
                    updateMoveDisplay();
                } else {
                    stopPlay();
                }
            }, 1000 / playSpeed);
        }
        
        function stopPlay() {
            isPlaying = false;
            document.getElementById('playBtn').textContent = '‚ñ∂ Play';
            
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
            }
        }
    </script>
</body>
</html>